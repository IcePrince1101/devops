## Part 1. Инструмент ipcalc.
#### 1.1. Сети и маски

- Установим ipcalc - `sudo apt install ipcalc`
- Получим адрес сети - `ipcalc 192.167.38.54/13 | grep Network`

![Part 1-1.](images/part1-1.jpg)

- Для перевода маски `255.255.255.0` в префиксную и двоичную - `ipcalc 255.255.255.0 | grep Netmask`. В префиксной записи `/24`, в двоичной - `11111111.11111111.11111111.00000000`
- Для перевода маски `/15` в обычную и двоичную - `ipcalc 0.0.0.0/15 | grep Netmask`. В обычной - `255.254.0.0', в двоичной - `11111111.11111110.00000000.00000000`

![Part 1-2.](images/part1-2.jpg)

- Перевод маски `11111111.11111111.11111111.11110000`: в префиксной - `/28`, в обычной - `255.255.255.240`. Проверим - `ipcalc 255.255.255.240` | grep Netmask`.

![Part 1-3.](images/part1-3.jpg)

- Найдем минимальный и максимальный хост в сети 12.167.38.4 при помощи `ipcalc 12.167.38.4(mask) | grep -e HostMin -e HostMax`. Маски - `/8`, `11111111.11111111.00000000.00000000`, `255.255.254.0`, `/4`

![Part 1-4.](images/part1-4.jpg)

#### 1.2 localhost

- Для проверки используем `ping "IP"`
- 194.34.23.100 - нет
- 127.0.0.2 - да
- 127.1.0.1 - да
- 128.0.0.1 - нет

#### Диапазоны и сегменты сетей

- Все, что имет формат 10.\*.\*.\*, 172.16.\*.\*-172.31.\*.\* или 192.168.\*.\* - всегда частные. Остальные - публичные.

- 10.0.0.45 - частный
- 134.43.0.2 - публичный
- 192.168.4.2 - частный
- 172.20.250.4 - публичный
- 172.0.2.1 - публичный
- 192.172.0.1 - публичный
- 172.68.0.2 - публичный
- 172.16.255.255 - приватный
- 10.10.10.10 - частный
- 192.169.168.1 - публичный

- какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18

![Part 1-5.](images/part1-5.jpg)

- 10.0.0.1 - нет
- 10.10.0.2 - да
- 10.10.10.10 - да
- 10.10.100.1 - нет
- 10.10.1.255 - да

## Part 2. Статическая маршрутизация между 2 машинами.

- Смотрим существующие сетевые интерфейсы - `ip a`

![Part 2-1.](images/part2-1.jpg)

- Опишем сетевой интерфейс и зададим адреса и маски для обеих виртуальных машин - `vim /etc/netplan/00-installer-config.yaml`

![Part 2-2.](images/part2-2.jpg)

- `sudo netplan apply`

![Part 2-3.](images/part2-3.jpg)

#### 2.1 Добавление статического маршрута вручную

- Воспользуемся командой - `sudo ip r add (IP) via enp0s3
- Пропингуем соединение - `ping -c 4 (IP)`

![Part 2-4.](images/part2-4.jpg)

#### 2.2 Добавление статического маршрута с сохранением

- Изменяем файлы конфигов

![Part 2-5.](images/part2-5.jpg)

- Пропингуем

![Part 2-6.](images/part2-6.jpg)

## Part 3. Утилита iperf3.
#### Скорость соединения

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps - 1024 Mbps

#### Утилита iperf3

- Установим iperf3
- Измерим скорость соединения. Для этого на сервере пишем - `iperf3 -s`, на клиенте - `iperf3 -c (IP)`

![Part 3-1.](images/part3-1.jpg)
![Part 3-2.](images/part3-2.jpg)

## Part 4. Сетевой экран
#### Утилита iptables

- Создаем файл - `sudo touch /etc/firewall.sh`
- Открываем и редактируем - `sudo vim /etc/firewall.sh`.

![Part 4-1.](images/part4-1.jpg)

- Добавляем разрешения - `sudo chmod +x /etc/firewall.sh`
- Запускаем - `sudo /etc/firewall.sh`
- Пингуем - `ping -c 4 1.1.1.1`
- Выводим статистику - `sudo iptables -L -v -n`. -L - это список правил, -v - подробный вывод (кол-во пакетов, байт), -n - отображение IP-адересов в числовом формате, а не в виде имени

![Part 4-2.](images/part4-2.jpg)

- Разница в стратегиях заключается в том, что изза применения первого подходящего правила в первой стратегии сначала будет применяться запрещающее правило, и только те пакеты, которые пройдут, будут проверяться на разрешающее правило. Во второй стратегии наоборот. Таким образом, на выходе мы получим разные пакеты.

#### 4.2 Утилита nmap

- Находим не пингующуюся машину - ws1
- Вызываем `nmap (IP)`

![Part 4-3.](images/part4-3.jpg)

- Сохраняем дампы

![Part 4-4.](images/part4-4.jpg)
![Part 4-5.](images/part4-5.jpg)

## Part5. Статическая маршрутизация сети

- Поднимаем 5 виртуальных машин

![Part 5-1.](images/part5-1.jpg)

- Даем им имена - ws11, ws21, ws22, r1, r2

![Part 5-2.](images/part5-2.jpg)
![Part 5-3.](images/part5-3.jpg)

#### 5.1. Настройка адресов машин

- Изменим файлы `sudo vim /etc/netplan/00-installer-config.yaml`

![Part 5-4.](images/part5-4.jpg)
![Part 5-5.](images/part5-5.jpg)

- Применим конфиги - `sudo netplan apply`
- Выведем информацию - `ip -4 a`

![Part 5-6.](images/part5-6.jpg)
![Part 5-7.](images/part5-7.jpg)

- Пропингуем ws22 с ws21

![Part 5-8.](images/part5-8.jpg)

- Пропингуем r1 c ws11

![Part 5-9.](images/part5-9.jpg)

#### 5.2. Включение переадресации IP-адресов

- Включим переадресацию командой - `sudo sysctl -w net.ipv4.ip_forward=1`

![Part 5-10.](images/part5-10.jpg)

- Изменим файл `/etc/sysctl.conf`

![Part 5-11.](images/part5-11.jpg)

#### 5.3. Установка маршрута по умолчанию

- Изменим файл `/etc/netplan/00-installer-config.yaml`

![Part 5-12.](images/part5-12.jpg)

- Вызовем - `ip r`

![Part 5-13.](images/part5-13.jpg)

- Пропингуем ws11 с r2, на r2 вызовем `tcpdump -tn -i enp0s3`

![Part 5-14.](images/part5-14.jpg)

#### 5.4. Добавление статических маршрутов

- Изменим файл `/etc/netplan/00-installer-config.yaml` для r1 и r2

![Part 5-15.](images/part5-15.jpg)

- Применим правила и вызовем `ip r`

![Part 5-16.](images/part5-16.jpg)

- Запустим на ws11 2 команды - `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`

![Part 5-17.](images/part5-17.jpg)

- были выбраны отличные маршруты, так как в приоритетете всегда выбирается маршрут с более длинной маской - он дает более точное решение.

#### 5.5. Построение списка маршрутизаторов.

- На r1 - `sudo tcpdump -tnv -i enp0s3`

![Part 5-18.](images/part5-18.jpg)

- На ws11 - `traceroute 10.20.0.10`

![Part 5-19.](images/part5-19.jpg)

- Утилита traceroute отправляет 3 UDP-пакета (UPD - отправляет пакеты и не ждет ничего в ответ) вместо одного ICMP (протокол для передачи сообщений об ошибок) запроса. После этого он ожидает ответа о недоступности определенного порта целевого хоста. Пакеты отправляются с порядковым номером (первый пакет с TTL=1, второй с TTL=2 и т.д.). Так как отправляется UDP, то в нем есть порт отправителя, и порт получателя. По умолчанию этот порт - 34434. Когда адрес попадает на нужный хост, хост отправит ошибку недоступности порта ('Destination port unreacheble') - мы видим, что адресат получил запрос. Для traceroute - это знак завершения работы.

#### 5.6. Использование протокола ICMP при маршрутизации.

- Запустим на r1 - `tcpdump -n -i enp0s3 icmp`
- На ws1 запустим - `ping -c 1 10.30.0.111`

![Part 5-20.](images/part5-20.jpg)
![Part 5-21.](images/part5-21.jpg)

- Сохраним дампы виртуальных машин

![Part 5-22.](images/part5-22.jpg)

## Part 6. Динамическая настройка IP с помощью DHCP

- Настроим службу DHCP для r2 - `sudo vim /etc/dhcp/dhcpd.conf`

![Part 6-1.](images/part6-1.jpg)

- `sudo apt install isc-dhcp-server`

- `subnet 10.100.0.0 netmask 255.255.0.0` - описание подсети с IP адресом и маской подсети. В фигурных скобках - дополнительные настройки (конкретно для данной подсети их нет).
- `range 10.20.0.2 10.20.0.50` - указывает диапазон IP-адресов, которые DHCP может назначит клиентам в этой подсети (от 10.20.0.2 до 10.20.0.50)
- `option routers 10.20.0.1` - указывает адрес шлюза по умолчанию (маршрутизатора)
- `option domain-name-servers 10.20.0.1` -  указывает IP-адрес сервера DNS для этой сети

- Открываем `sudo vim /etc/resolv.conf` и меняем nameserver >> 8.8.8.8

![Part 6-2.](images/part6-2.jpg)

- Перезагружаем службу DHCP - `sudo systemctl restart isc-dhcp-server`

![Part 6-3.](images/part6-3.jpg)

- Проверим ws1 - `ip a`

![Part 6-4.](images/part6-4.jpg)

- Пропингуем ws22 с ws21

![Part 6-5.](images/part6-5.jpg)

- Укажем MAC адрес у ws11 - `sudo vim /etc/netplan/00-installer-config.yaml`

![Part 6-6.](images/part6-6.jpg)

- Настроим и запустим DHCP на r1

![Part 6-7.](images/part6-7.jpg)
![Part 6-8.](images/part6-8.jpg)

- Выведем IP для ws11 и пропингуем ws22

![Part 6-9.](images/part6-9.jpg)
![Part 6-10.](images/part6-10.jpg)

- Запросим обновление адреса для ws21 - `sudo dhclient`

![Part 6-11.](images/part6-11.jpg)
![Part 6-12.](images/part6-12.jpg)

- Сохраним дампы образов виртуальных машин

![Part 6-13.](images/part6-13.jpg)

## Part 7. NAT.

- Изменяем файл `/etc/apache2/ports.conf`

![Part 7-1.](images/part7-1.jpg)

- Запускаем веб-сервер Apache - `service apache2 start`

![Part 7-2.](images/part7-2.jpg)

- Добавляем в фаервол правила

![Part 7-3.](images/part7-3.jpg)

- Не пингуется

![Part 7-4.](images/part7-4.jpg)

- Меняем файл `/etc/firewall.sh`

![Part 7-5.](images/part7-5.jpg)

- Пингуем

![Part 7-6.](images/part7-6.jpg)

- Меняем файл `/etc/firewall.sh`

![Part 7-7.](images/part7-7.jpg)

- Проверяем соединение

![Part 7-8.](images/part7-8.jpg)

- Создаем дампы

![Part 7-8.](images/part7-8.jpg)

## Part 8. Дополнительно. Знакомство с SSH Tunnels.

- Запускаем на r2 фаервол

![Part 8-1.](images/part8-1.jpg)

- Запускаем веб-сервер Apache только на localhost

![Part 8-2.](images/part8-2.jpg)

- Воспользуемся Local TCP forwarding с ws21 до ws22 - `ssh -L 9999:localhost:80 10.20.0.20`

![Part 8-3.](images/part8-3.jpg)

- Воспользуемся Remote TCP forwarding с ws11 до ws22 - для этого в терминале ws22 пишем `ssh -R 8888:localhost:80 10.10.0.2`

![Part 8-4.](images/part8-4.jpg)

- Проверим подключение - `telnet 127.0.0.1 8888 (или 9999)`

![Part 8-5.](images/part8-5.jpg)
![Part 8-6.](images/part8-6.jpg)

- Создадим дампы машин

![Part 8-7.](images/part8-7.jpg)